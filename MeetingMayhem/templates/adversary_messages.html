<!-- 
    File: adversary_messages.html
    Author: Robert Shovan /Voitheia
    Date Created: 6/24/2021
    Last Modified: 7/6/2021
    E-mail: rshovan1@umbc.edu
    Description: html and jinja file for handling the adversary messages page
    messages.html and this file could be combined using if statements to check if the current user is an adversary
    we might want to do that in the future so that we don't have to edit two message sections in two documents
-->
{% import 'messages.j2' as messages %}

{% extends "layout.html" %} <!-- this tells jinja that we are using a template -->
{% block content %} <!-- this piece of code tells jinja where to put the html for this page in the parent template -->
<h1 class="float-start" style="color: black; font-weight: bold; text-shadow: 2px 2px 2px rgb(250, 236, 33); padding-left: 0.4in">Messages</h1>
    <!-- this part here is just copied from messages.html -->
	<div class="tab">
		<button class="tablinks" name="{{other_names[0]}}"style="background-color: #000000;
		color: rgb(255, 255, 255);
		font-size: 20px;
		border-color:rgb(201, 191, 12);
		border-radius: 5px;
		padding: 5px;
		padding-left: 10px; padding-right: 10px;
		border-style:solid; border-width: 2px; margin-left: 80px; " onclick="openUser(event, '{{other_names[0]}}')">{{other_names[0]}}</button>
		<button class="tablinks" name="{{other_names[1]}}" style=" background-color: #000000;
		color: rgb(255, 255, 255);
		font-size: 20px;
		border-color:rgb(201, 191, 12);
		border-radius: 5px;
		padding: 5px;
		padding-left: 10px; padding-right: 10px;
		border-style:solid; border-width: 2px; margin-top: 30px;" onclick="openUser(event, '{{other_names[1]}}')">{{other_names[1]}}</button>
		<button class="tablinks" name="editTab" style= "background-color: #000000;
		color: rgb(255, 255, 255);
		font-size: 20px;
		border-color:rgb(201, 191, 12);
		border-radius: 5px;
		padding: 5px;
		padding-left: 10px; padding-right: 10px;
		border-style:solid; border-width: 2px; margin-top: 30px;" onclick="openUser(event, 'editTab')">{{other_names[0]}}_{{other_names[1]}}</button>
  </div>
  
	 <!-- Tab content -->
  {% for index in range(other_names|length) %}
	 {% set name = other_names[index] %}
	 {% set pname = pretend_name[index] %}
	 {% set form = forms[name]%}
	 <div id="{{name}}" class="tabcontent">
		<form method="POST" action="/messages" id="form_{{name}}">
		   {{ form.hidden_tag() }}
		<fieldset class="form-group">
		   <div class="row">
			  <div class="column" style="background-color: rgb(0, 0, 0); color: #fff9f9; border: thick double rgb(201, 191, 12); padding: 0.5cm; width: 60%; height: 500px; overflow-y: auto; overflow-x: auto; margin-top: 30px; border-radius: 25px; scrollbar-gutter: stable;">
				 <style>
				 /* width */
				 ::-webkit-scrollbar {
				 width: 10px;
				 }
				 
				 /* Track */
				 ::-webkit-scrollbar-track {
				 box-shadow: inset 0 0 5px grey; 
				 border-radius: 7px;
				 }
				 
				 /* Handle */
				 ::-webkit-scrollbar-thumb {
				 background: rgb(194, 191, 122); 
				 border-radius: 10px;
				 }
				 
				 /* Handle on hover */
				 ::-webkit-scrollbar-thumb:hover {
				 background: #52502d; 
				 }
				 ::-webkit-scrollbar-corner {
					background:rgb(0, 0, 0);
					border-radius: 7px;
  
				 }
			  </style>
			  {% set profile = image_url[index] %}
			  <h2>{{name}} <img src="{{profile}}" alt="profile_img"  style ="width: 60px; height: 60px; object-fit: cover; border-radius: 50%; margin-right: 10px; background-color: #0dcaf0;" /> </h2>
			  <!-- Msg can be displayed-->
			  {% if msgs_flag[index] %}
				 {% for message in msgs_tuple[index] %}
					<!-- left recieved-->
					{% if message[3] %} 
                     	{% set leftmargin = 5 %}
                  	<!-- right send-->
                  	{% else %}
                     	{% set leftmargin = 480 %}
                  	{%  endif %}
					{% if message[0].adv_processed and not message[0].adv_created %}
					  {% set bordercolor = "#dad707" %}
					{% else %}
					  {% set bordercolor ="#0dcaf0" %}
				   	{%  endif %}
					<div class="chatbox" style="width: 220px; height: auto; margin-left:{{ leftmargin }}px; margin-top: 5px; font-size: 12px">
						<p>{{ message[2]}}</p>
						<div class="content" style="background-color: #333333; color: white; font-size: 15px;
						border-color: #0dcaf0;
						border-radius: 10px;
						padding: 5px;
						border-width: 2px; border: thick double {{ bordercolor }}; width: 250px; height: auto;  word-wrap: break-word;">
						<!-- adv fake as message sent to others-->
						<!-- can decrypt and is recieved -->
						{% if message[3] %}
							{% if message[0].edited_is_cyptographic != 0 %}
								{% if message[0].is_decryptable_user %}
									{% if message[0].has_been_decrypted_user %}
										<p style="color: #0dcaf0">{{ message[0].location_meet }} @ {{message[0].time_meet}} {{message[0].time_am_pm}}</p>
										<p class="article-content">{{ message[0].edited_content }}</p>
									{% else %}
										<div id="decryption-{{ message[0].id }}-{{ message[0].edited_recipient }}" class="row g-2 align-items-center" data-group="decrypt_options" onclick="prevent_outer(this)">
								<div class="col">
									<select id="decryption_type_select-{{message[0].id}}"  class="form-select form-select-sm mb-3 gray-blue" aria-label=".form-select-lg example" name="decryption_type_select-{{message[0].id}}">
										<option value= "-1" selected>No Decryption/Verification of Signature</option>
										<option value="symmetric">Symmetrically Decrypt</option>
										<option value="asymmetric">Asymmetrically Decrypt</option>
										<option value="signed">Verify Signature</option>
									</select>
								</div>
								with
								<div class="col">
									<select id="decryption_key_select-{{ message[0].id }}"  class="form-select form-select-sm mb-3 gray-blue" aria-label=".form-select-lg example">
										<option value= "-1" selected id="default_key_select-{{ message[0].id }}">No Key Selected</option>
										{% set current_user_name = current_user.username -%}
										{% for username,_ in usernames %}
										{% if current_user_name != username %}
										<option value="Shared_{{current_user_name}}_{{username}}">Shared Symmetric Key for {{current_user_name}} and {{username}} </option>
										{% endif %}
										{% endfor %}
										{% for username,_ in usernames %}
										<option value="public_{{username}}">{{username}}'s Public Key</option>
										{% if current_user_name == username %}
										<option value="private_{{username}}">{{username}}'s Private Key </option>
										{% endif %}
										{% endfor %}
									</select>
								</div>
										</div>
										<button id="decrypt-{{message[0].id}}-{{message[0].edited_sender}}-{{message[0].edited_recipient}}-{{message[0].edited_encryption_type}}-{{message[0].edited_key}}" class="btn btn-secondary decrypt-button" onclick="decrypt(this.id)">Decrypt</button> 
									{% endif %}
								{% else %}
									<p class="article-content">--CANNOT DECRYPT--</p>
								{% endif %}
							{% else %}
								<p style="color: #0dcaf0">{{ message[0].location_meet }} @ {{message[0].time_meet}} {{message[0].time_am_pm}}</p>
								<p class="article-content">{{ message[0].edited_content }}</p>
							{% endif %}
						{% else %}
							{% if message[0].adv_processed and not message[0].adv_created %}
								<p style="color: #0dcaf0">{{ message[0].location_meet }} @ {{message[0].time_meet}} {{message[0].time_am_pm}}</p>
								<p class="article-content" > {{ message[0].edited_content }}</p>
							{% else %}
								<p style="color: #0dcaf0">{{ message[0].location_meet }} @ {{message[0].time_meet}} {{message[0].time_am_pm}}</p>
								<p class="article-content">{{ message[0].initial_content }}</p>
							{% endif %}
						{% endif %}
                     </div>
					{% if not message[3] and not message[0].adv_processed %}
						{% set is_cyptographic = message[0].initial_is_cyptographic %}
						{% set encryption_type = message[0].initial_encryption_type %}
						{% set encryption_key = message[0].initial_key %}
						{% set help_message = message[0].initial_help_message %}
					{% else %} 
						{% set is_cyptographic = message[0].edited_is_cyptographic %}
						{% set encryption_type = message[0].edited_encryption_type %}
						{% set encryption_key = message[0].edited_key %}
						{% set help_message = message[0].edited_help_message %}
					{% endif %}
					{% if is_cyptographic != 0 %}
                     	{% if 'Warning' not in help_message %} 
                        	{% set isBorderSucess = "success" %}
                     	{% else %}
                        	{% set isBorderSucess = "warning" %}
                     	{% endif %}
					
                     <div class="m-1 row " style="width:120%">
                        {% if encryption_type == 'symmetric' %}
                        <div class="rounded-start d-inline col-md-auto bg-{{ isBorderSucess }} text-dark border border-3 border-{{ isBorderSucess }}">
							SE <span title="Symmetrically Encrypted with">&#9432;</span>:</div>
                        {% elif encryption_type == 'asymmetric' %}
                           <div class="rounded-start d-inline col-md-auto bg-{{ isBorderSucess }} text-dark border border-3 border-{{ isBorderSucess }}">
							AS <span title="Asymmetrically Encrypted with">&#9432;</span>:</div>
                        {% elif encryption_type == 'signed' %}
                           <div class="rounded-start d-inline col-md-auto bg-{{ isBorderSucess }} text-dark border border-3 border-{{ isBorderSucess }}">
                              Signed by:</div>
                        {% endif %}
                        <div class="rounded-end d-inline col-md-auto border border-3 border-{{ isBorderSucess }}">{{
							encryption_key }} <span title="{{ help_message}}">&#9432;</span></div>
                     </div>
                  {% endif %}
			  	</div>
				 {% endfor %}
			  {% endif %}
  
			  <!-- <hr class="rounded" style="border: thick double ; background-color: rgb(201, 191, 12); margin-top: 500px;">
			  {% set  id_content= "content_" + name %}
			  {{ form.content(class="form-control form-control-lg", style="margin:10px;", placeholder="Enter your message here",id=id_content) }}
			  
			  <div class="form-group" id="{{name}}_form">
				 {% set  id_button= "button_" + name %}
				 {% set  id_button_form= "Send Message to " + name %}
				 {{ form.submit(class="btn btn-outline-info",id=id_button,value=id_button_form) }}
			  </div> -->
			  
		   </div>
		
		   <div class="column" style="background-color: #000000; color: #fff9f9; border: thick double rgb(201, 191, 12); padding: 0.5cm; width: 40%; height: 500px; overflow-y: auto; overflow-x: auto; margin-top: 30px; border-radius: 25px;">
			  <h2>{{name}}</h2>
			  <p style="color:aliceblue; text-shadow: 2px 2px 2px #0dcaf0; font-size: large;">Message Information</p>
			  <input class="form-check-input" type="checkbox" id="{{name}}_pretend" name="Pretend"
			  value="{{ pname }}" >
			  <label class="form-check-label" for="inlineCheckbox1-{{name}}"> Pretend as {{ pname }}</label>
				</br>
				</br>
			  {% set  id_loc= "locations_" + name %}
			  {% set  id_time= "time_" + name %}
			  {% set  id_am= "am_" + name %}
			  <div class="form-group" id="{{name}}_form_2">
				 {{ form.content.label(class="form-control-label") }}
				 <!-- i think this tells jinja to put a form box in here -->
				 {{ form.meet_location (class="gray-blue",id=id_loc)}}
				 <img id="location-image_{{ name }}" width="300px" height="180px" src="/images/Arts/Locations/Cafe_new.png"
					style="display:block;margin:20px;">
				 {{ form.meet_time (class="gray-blue",id=id_time)}}
				 {{ form.meet_am_pm (class="gray-blue",id=id_am) }}
			  </div>
			  <div id="encryption-panel" class="content-section bg-dark" style="color: #0dcaf0; width: auto;margin-top: 20px">
				<ul class="select2-selection__rendered" id="cryptography_tags_list_{{ name }}"></ul>
				 <p style="font-size: 20px; font-weight: bold; font-size: 15px;">Encrypt or Sign Message:</p><br>
				 <p style="color:aliceblue; text-shadow: 2px 2px 2px #0dcaf0; font-size: medium;">Cryptographic Operation</p>
				 
				 <div class="row g-2 align-items-center">
					<div class="col" style="width:220px; float:left">
					   <select id="encryption_sign_type_select_{{ name }}" class="form-select form-select-sm mb-3 gray-blue" aria-label=".form-select-lg example" name="encryption_type_select" style="width: 220px">
						  <option value="-1" selected>No Encryption/Signature</option>
						  <option value="symmetric">Symmetrically Encrypt</option>
						  <option value="asymmetric">Asymmetrically Encrypt</option>
						  <option value="signed">Sign</option>
					   </select>
					</div>
					
					<div style="color: #0dcaf0; font-size: large; width: 100px; float: right; margin-right: 60px">with</div> 

		   <div class="col">
			<p style="color:aliceblue; text-shadow: 2px 2px 2px #0dcaf0; font-size: medium;">Key Options</p>

			  <select id="key_select_{{ name }}" class="form-select form-select-sm mb-3 gray-blue" aria-label=".form-select-lg example" name="encryption_key" style="width:400px;">
				 <option id='default_key_select_{{ name }}' value="-1" selected>No Key Selected</option>
				 {% set current_user_name =  current_user.username  -%}
				 {% for username,_ in usernames %}
				 {% if current_user_name != username %}
				 <option value="Shared_{{current_user_name}}_{{username}}">Shared Symmetric Key for {{current_user_name}} and {{username}}</option>
				 {% endif %}
				 {% endfor %}
				 {% for username,_ in usernames %}
				 <option value="public_{{username}}">{{username}}'s Public Key</option>
				 {% if current_user_name == username %}
				 <option value="private_{{username}}">{{username}}'s Private Key</option>
				 {% endif %}
				 {% endfor %}
				 </select>
			  </div>
		</div>
			  </div>
		   </div>   

		   <div style="background-color: #000000;  border: thick double rgb(201, 191, 12); height: auto; border-radius: 25px; margin-top:5px; padding-left: 20px; padding-right:20px; width: 1500px" >
			<div style="width: 950px; float: left; color: #fff9f9;">

			{% set  id_content= "content_" + name %}
            {{ form.content(class="form-control form-control-lg", placeholder="Enter your message here",id=id_content) }}
            </div>
            <div class="form-group" id="{{name}}_form" style="width: 200px; float: right; margin-right: 80px">
				{% set  id_button= "button_" + name %}
               {% set  id_button_form= "Send Message to " + name %}
               {{ form.submit(class="btn btn-outline-info",id=id_button,value=id_button_form) }}
            </div>
         </div>
	 <!-- <div id="error-message_{{ name }}" hidden="hidden"><p>You need to select both Keys and Encryption/Signed type</p></div> -->
	 {% if form.content.errors %}
		<div class="invalid-feedback">
		   {% for errors in form.content.errors %}
			  {{ errors }} <!-- display the errors -->
		   {% endfor %}
		   {% endif %}
		</div>
	 <br>
	 </fieldset>
	 </form>
  </div>
{% endfor %}

<!-- Edited form -->
<div id="editTab" class="tabcontent">
	{% set modifyName = other_names[0] + "_" + other_names[1]%}
	{% set adv_msg_edit_form = forms[modifyName]%}
	<div class="row">
		<div class="column" style="background-color: rgb(0, 0, 0); color: #fff9f9; border: thick double rgb(201, 191, 12); padding: 0.5cm; width: 60%; height: 750px; overflow-y: auto; overflow-x: auto; margin-top: 30px; border-radius: 25px; scrollbar-gutter: stable;">
		<style>
		/* width */
		::-webkit-scrollbar {
		width: 10px;
		}
		
		/* Track */
		::-webkit-scrollbar-track {
		box-shadow: inset 0 0 5px grey; 
		border-radius: 7px;
		}
		
		/* Handle */
		::-webkit-scrollbar-thumb {
		background: rgb(194, 191, 122); 
		border-radius: 10px;
		}
		
		/* Handle on hover */
		::-webkit-scrollbar-thumb:hover {
		background: #52502d; 
		}
		::-webkit-scrollbar-corner {
		background:rgb(0, 0, 0);
		border-radius: 7px;

		}
		</style>
		{% set profile1 = image_url[0] %}
		{% set profile2 = image_url[1] %}
		<h2>{{other_names[0]}} <img src="{{profile1}}" alt="profile_img"  style ="width: 60px; height: 60px; object-fit: cover; border-radius: 50%; margin-right: 10px; background-color: #0dcaf0;" /> </h2>
		<h2 style = "margin-right:10px;margin-left:430px;margin-top:-67px;">{{other_names[1]}} <img src="{{profile2}}" alt="profile_img"  style ="width: 60px; height: 60px; object-fit: cover; border-radius: 50%; margin-right: 100px;background-color:#0dcaf0;" /> </h2> 
		<!-- left recieved-->
			{% for message in editMessage %}
				<!-- Set all properties-->
				<!-- Message on left-->
				{% if message[2] %} 
					{% set leftmargin = -10 %}
				{% else %}
					{% set leftmargin = 460 %}
				{%  endif %}
				{% if message[0].adv_processed %}
					{% if message[0].is_deleted %}
						{% set bordercolor = "#f00d0d" %}
						{% set status = "Deleted" %}
					{% elif message[0].is_edited %}
						{% set bordercolor = "#dad707" %}
						{% set status = "Forward with edition" %}
					{% else %}
						{% set bordercolor = "#0dca45" %}
						{% set status = "Forward without edition" %}
					{% endif %}
				{% else %}
					{% set bordercolor = "#0dcaf0" %}
				{% endif %}
				<div  class="chatbox" style="width: 130px; height: auto; margin-left:{{ leftmargin }}px; margin-top: 5px; font-size: 12px">
					{% if not message[0].adv_processed %}
						<article id="disp-msg-{{(message[0]).id}}" class="option media content-section" onclick="select_msg(this, '{{(message[0]).id}}','{{(message[0]).initial_sender}}','{{(message[0]).initial_recipient}}')">
					{% else %}
						<article id="disp-msg-{{(message[0]).id}}" class="option media content-section">
					{% endif %}	
						
					<p>{{ message[1]}}  <span title="{{ status }}">&#9432;</span></p>	
					<!-- {% if message[0].adv_processed %}
						<p>New Sender: {{message[0].edited_sender}}</p>
						<p>New Recipient: {{message[0].edited_recipient}}</p>
					{% endif %} -->
						<div class="content" style="background-color: #333333; color: #0dcaf0; font-size: 15px;
						border-color: #0dcaf0;
						border-radius: 10px;
						padding: 5px;
						border-width: 2px; border: thick double {{ bordercolor }}; width: 250px; height: auto;  word-wrap: break-word;">
						<!-- message is decrytable but not done yet -->
						{% if message[0].initial_is_cyptographic!=0 and not message[0].adv_processed %}
							{% if message[0].has_been_decrypted_adv %}
								{% if message[0].is_edited %}
									<p style="color: #0dcaf0">{{ message[0].location_meet }} @ {{message[0].time_meet}} {{message[0].time_am_pm}}</p>
									<div id="content-{{ message[0].id }}-adv" class="article-content">{{ message[0].edited_content }} </div>
								{% else %}
									<p style="color: #0dcaf0">{{ message[0].location_meet }} @ {{message[0].time_meet}} {{message[0].time_am_pm}}</p>
									<div id="content-{{ message[0].id }}-adv" class="article-content">{{ message[0].initial_content }}</div> 	
								{% endif %}
							{% elif message[0].is_decryptable_adv %}
								<div id="decryption-{{ message[0].id }}-{{ message[0].initial_recipient }}-adv" class="row g-2 align-items-center" data-group="decrypt_options_adv" onclick="prevent_outer(this)">
									<div class="col">
										<select id="decryption_type_select-{{message[0].id}}-adv"  class="form-select form-select-sm mb-3 gray-blue" aria-label=".form-select-lg example" name="decryption_type_select-{{message[0].id}}-adv">
											<option value= "-1" selected>No Decryption/Verification of Signature</option>
											<option value="symmetric">Symmetrically Decrypt</option>
											<option value="asymmetric">Asymmetrically Decrypt</option>
											<option value="signed">Verify Signature</option>
										</select>
									</div>
									<div class="col">
										<select id="decryption_key_select-{{ message[0].id }}-adv"  class="form-select form-select-sm mb-3 gray-blue" aria-label=".form-select-lg example">
											<option value= "-1" selected id="default_key_select-{{ message[0].id }}-adv">No Key Selected</option>
											{% set current_user_name = current_user.username -%}
											{% for username,_ in usernames %}
												{% if current_user_name != username %}
												<option value="Shared_{{current_user_name}}_{{username}}">Shared Symmetric Key for {{current_user_name}} and {{username}} </option>
												{% endif %}
											{% endfor %}
											{% for username,_ in usernames %}
												<option value="public_{{username}}">{{username}}'s Public Key</option>
												{% if current_user_name == username %}
												<option value="private_{{username}}">{{username}}'s Private Key </option>
												{% endif %}
											{% endfor %}
										</select>
									</div>
								</div>
								<button id="decryptadv-{{message[0].id}}-{{message[0].initial_sender}}-{{message[0].initial_recipient}}-{{message[0].initial_encryption_type}}-{{message[0].initial_key}}" class="btn btn-secondary decrypt-button" onclick="decrypt_adv(this.id)">Decrypt</button> 
							{% else %}
								<div id="content-{{ message[0].id }}-adv" class="article-content">--CANNOT DECRYPT--</div>
							{% endif %}
						<!-- adv already forward the message but not decrypt it -->
						{% elif message[0].initial_is_cyptographic!=0 and ((message[0].is_decryptable_adv and not message[0].has_been_decrypted_adv) or (not message[0].is_decryptable_adv)) %}
							<div id="content-{{ message[0].id }}-adv" class="article-content">--CANNOT DECRYPT--</div>
						{% else %}
							{% if message[0].is_edited %}
								<p style="color: #0dcaf0">{{ message[0].location_meet }} @ {{message[0].time_meet}} {{message[0].time_am_pm}}</p>
								<div id="content-{{ message[0].id }}-adv" class="article-content">{{ message[0].edited_content }}</div>
							{% else %}
							    <p style="color: #0dcaf0">{{ message[0].location_meet }} @ {{message[0].time_meet}} {{message[0].time_am_pm}}</p>
								<div id="content-{{ message[0].id }}-adv" class="article-content">{{ message[0].initial_content }}</div>
							{% endif %}
						{% endif %}
					    </div>
					{% if message[0].initial_is_cyptographic != 0 and not message[0].has_been_decrypted_adv  %}
						{% if 'Warning' not in message[0].initial_help_message %} 
							{% set isBorderSucess = "success" %}
						{% else %}
							{% set isBorderSucess = "warning" %}
						{% endif %}
						<div class="m-1 row " style="width: 120%;">
						{% if message[0].initial_encryption_type == 'symmetric' %}
						<div class="rounded-start d-inline col-md-auto bg-{{ isBorderSucess }} text-dark border border-3 border-{{ isBorderSucess }}">
							SE <span title="Symmetrically Encrypted with">&#9432;</span>:</div>
						{% elif message[0].initial_encryption_type == 'asymmetric' %}
							<div class="rounded-start d-inline col-md-auto bg-{{ isBorderSucess }} text-dark border border-3 border-{{ isBorderSucess }}">
							AE <span title="Asymmetrically encrypted with">&#9432;</span>:</div>
						{% elif message[0].initial_encryption_type == 'signed' %}
							<div class="rounded-start d-inline col-md-auto bg-{{ isBorderSucess }} text-dark border border-3 border-{{ isBorderSucess }}">
							Signed by:</div>
						{% endif %}
						<div class="rounded-end d-inline col-md-auto border border-3 border-{{ isBorderSucess }}">{{
							message[0].initial_key }} </div>
						</div>
			 		{% endif %}
				</article>
			</div>
			{% endfor %}
	</div>	
			<!-- right side -->
		    <div id = "edit_form" class="inactive" style="background-color: #000000; color: #fff9f9; border: thick double rgb(201, 191, 12); padding: 0.5cm; width: 40%; height: 750px; overflow-y: auto; overflow-x: auto; margin-top: 30px; border-radius: 25px;">
	   		<legend class="border-bottom mb4" style="color: rgb(250, 236, 33); font-size:30px; font-weight: bold; text-shadow: 2px 2px 2px rgb(128, 122, 4); padding-left: 0.1in; padding-bottom: 5px">Edit a Message</legend>
			<div class="content-section">
				<form method="POST" action="">
				{{ adv_msg_edit_form.hidden_tag() }}
				<fieldset class="form-group">
					<div class="form-group">
						<label class="form-control-label" style="margin-top: 0.1in; margin-bottom: 0.1in; 
							background-color: #333333;
							color: #0dcaf0;
							font-size: 15px;
							border-color:#0dcaf0;
							border-radius: 5px;
							padding: 5px;
							padding-left: 10px; padding-right: 10px;
							text-align: center; border-style:solid; border-width: 2px">New Sender:
						</label>  <br />
							{{messages.user_interface(usernames,"newsenders",true,"")}}
					</div> <br/>
					<div class="form-group">
						<label class="form-control-label" style="margin-top: 0.1in; margin-bottom: 0.1in; 
							background-color: #333333;
							color: #0dcaf0;
							font-size: 15px;
							border-color:#0dcaf0;
							border-radius: 5px;
							padding: 5px;
							padding-left: 10px; padding-right: 10px;
							text-align: center; border-style:solid; border-width: 2px">New Recipient:</label>  <br />
							{% set current_user_name =  current_user.username  -%}
							{{messages.user_interface(usernames,"newrecipients",true,current_user_name)}}
					</div> <br/>
					<div class="form-group" style="margin-bottom: -50px">
						{{ adv_msg_edit_form.edited_content.label(class="form-control-label") }} <!-- i think this tells jinja to put a form box in here -->
						{% if adv_msg_edit_form.edited_content.errors %} <!-- if there are errors in the form... -->
							{{ adv_msg_edit_form.edited_content(id="adv_msg_edit_form", class="form-control form-control-lg is-invalid") }}
							<div class="invalid-feedback">
								{% for errors in adv_msg_edit_form.edited_content.errors %}
									<span>{{ errors }}</span> <!-- display the errors -->
								{% endfor %}
							</div>
						{% else %} <!-- if there aren't errors, just display normally -->
							{% if message.edited_content %} <!-- if the message has been edited, display the edited parts-->
								{{ adv_msg_edit_form.edited_content(id="adv_msg_edit_form", class="form-control form-control-lg",value=message.edited_content) }}
							{% else %} <!-- if the message hasn't been edited, display normally -->
								{% if can_decrypt %}
									{{ adv_msg_edit_form.edited_content(id="adv_msg_edit_form", class="form-control form-control-lg",value=message.content) }}
								{% else %}
									{{ adv_msg_edit_form.edited_content(id="adv_msg_edit_form", class="form-control form-control-lg",value='Please select a message to edit!',disabled=true, style="width:400px")}}
								{% endif %}
							{% endif %}
						{% endif %}
					</div> <br>
					<div class="form-group">
						{{ adv_msg_edit_form.encryption_and_signed_keys(id="adv_encryption_and_signed_keys", type="hidden") }} 
					</div> <br/>
				</fieldset>
			</div>

			<div id="encryption-panel" class="content-section bg-dark" style="color: #0dcaf0; width: auto;">
				<ul class="select2-selection__rendered" id="adv_cryptography_tags_list"></ul>
				<ul class="select2-selection__rendered" id="cryptography_tags_list"></ul>
				<p style="font-size: 20px; font-weight: bold; font-size: 15px">Encrypt or Sign Message:</p> <br>
				<p style="color:aliceblue; text-shadow: 2px 2px 2px #0dcaf0; font-size: medium;">Cryptographic Operation</p>
				<div class="row g-2 align-items-center">
					<div class="col" style="width:230px; float:left">
						<select id="encryption_sign_type_select2" class="form-select form-select-sm mb-3 gray-blue" aria-label=".form-select-lg example" name="encryption_type_select2" style="width: 230px">
							<option  value= "-1" selected>No Encryption/Signature</option>
							<option value="symmetric">Symmetrically Encrypt</option>
							<option value="asymmetric">Asymmetrically Encrypt</option>
							<option value="signed">Sign</option>
						</select>

					</div>
					<div style="color: #0dcaf0; font-size: large; width: 100px; float: right; margin-right: 60px;">with</div> 

					<div class="col">
						<p style="color:aliceblue; text-shadow: 2px 2px 2px #0dcaf0; font-size: medium;">Key Options</p>

						<select id="key_select2" class="form-select form-select-sm mb-3 gray-blue" aria-label=".form-select-lg example"  name="encryption_key2" style="width:400px">
							<option id='default_key_select2' value= "-1" selected>No Key Selected</option>
							{% set current_user_name =  current_user.username  -%}
							{% for username,_ in usernames %}
								{% if current_user_name != username %}
								<option value="Shared_{{current_user_name}}_{{username}}">Shared Symmetric Key for {{current_user_name}} and {{username}} </option>
								{% endif %}
							{% endfor %}
							{% for username,_ in usernames %}
								<option value="public_{{username}}">{{username}}'s Public Key</option>
								{% if current_user_name == username %}
								<option value="private_{{username}}">{{username}}'s Private Key </option>
								{% endif %}
							{% endfor %}
						</select>
					</div>
				</div>
				<div id="error-message-2" hidden="hidden"><p>You need to select both Keys and Encryption/Signed type</p></div>
				<br/>
			</div>
			<div id="error-message-3" hidden="hidden"><p>No more add-on encryption because this message has been already encrypted!</p></div>
			<div class="form-group" style="margin:10px 0px;">
				<!-- previous, next, delete, and submit buttons for message editing -->
				{{ adv_msg_edit_form.delete_msg(class="btn btn-outline-info") }}
				{{ adv_msg_edit_form.submit_edits(class="btn btn-outline-info") }}
				<!-- {{ adv_msg_edit_form.send_no_change(class="btn btn-outline-info") }} -->
				{{ adv_msg_edit_form.msg_num(id="msg_num", type="hidden") }}
				{{ adv_msg_edit_form.not_editable(id="not_editable", type="hidden") }}
			</div>
			</fieldset>
			</form>
			</div>  
	</div>
		  
</div>
<script>
	function prevent_outer(e){
		// prvent trigger slect_msg() due to bubble effect
		window.event.stopPropagation();
	}
	function uncheckAll(){
		$('input[type="checkbox"]:checked').prop('checked',false);
	 }
	function select_msg(ele, num,sender,recipient) {
		uncheckAll();
		document.getElementById('edit_form').scrollIntoView();

		$(".content-section").removeClass("border border-5 border-info circle");
		$(ele).addClass("border border-5 border-info circle");
		
		//$(ele).addClass("border border-5 border-info circle").siblings().removeClass("border border-5 border-primary rounded");

		id = "content-" + num + "-adv";
		senderCheckBoxName = "inlineCheckbox1-" + sender + "-newsenders";
		recipientCheckBoxName = "inlineCheckbox1-" + recipient + "-newrecipients";
		//console.log(id)
		//console.log(sender,recipient)
		const content_box = document.getElementById(id);
		document.getElementById(senderCheckBoxName).checked = true;
		document.getElementById(recipientCheckBoxName).checked = true;
		var text ="--CANNOT DECRYPT--";
		var encrypt_button = document.getElementById("encryption-panel");
		var error_dis3 = document.getElementById("error-message-3");
		// null means it is encrypted, the value will be default value: "--CANNOT DECRYPT--"
		//console.log(window.getComputedStyle(content_box).display);
		if (content_box !== null && window.getComputedStyle(content_box).display !== "none"){
			text = document.getElementById(id).innerHTML;
			console.log(text);
		}		
		document.getElementById('adv_msg_edit_form').value = text; 
		if(text == "--CANNOT DECRYPT--"){
			document.getElementById('adv_msg_edit_form').disabled = true;
			encrypt_button.style.display = "none";
			error_dis3.removeAttribute("hidden");
			document.getElementById('not_editable').value = true; 
		}
		else{
			document.getElementById('adv_msg_edit_form').disabled = false;
			encrypt_button.style.display = "block";
			error_dis3.setAttribute("hidden", "hidden");
			document.getElementById('not_editable').value = false; 
		}
		document.getElementById('msg_num').value = num; 	
	}
	
	</script>

<!-- Sender can ONLY send to ONE recipients at a time -->
<!-- Refer from https://stackoverflow.com/questions/9709209/html-select-only-one-checkbox-in-a-group -->
<script>
	// For onlyOne click
	$('input[type="checkbox"]').on('change', function() {
		$('input[name="' + this.name + '"]').not(this).prop('checked', false);
	});
</script>
<script>
	// TODO: https://stackoverflow.com/questions/51135498/flask-update-the-page-content-without-redirection-in-ajax-jquery
	function decrypt_adv(id_button){
		const msg_id = id_button.split("-")[1];
		console.log(msg_id);
		const decryption_type = document.getElementById(`decryption_type_select-${msg_id}-adv`).value;
		const decryption_key = document.getElementById(`decryption_key_select-${msg_id}-adv`).value;
		var current_user_username = "{{ current_user.username }}";
		var socket = io();
		socket.emit('advdecrypted', {message: msg_id,decryption_key:decryption_key,decryption_type:decryption_type,curname:current_user_username});
		socket.on('finish_decrypt',(arg1) => {
			if (arg1 !== "Good Job!"){
				alert(arg1); // 1
			}	
		});
		socket.on('redirect', function (data) {
			console.log(data.url)
			window.location.reload(true);
			window.location.href = data.url;
		});
	}
</script>
<script>

	// This script will limit the permission of certain key
	var options_for_decrypt_adv = document.querySelectorAll('[data-group="decrypt_options_adv"]');
	for (let i = 0; i < options_for_decrypt_adv.length; i++) {
		msg_id = options_for_decrypt_adv[i].id.split("-")[1];
		current_user_username = options_for_decrypt_adv[i].id.split("-")[2].replace(',', '');
		decryption_type_select = document.getElementById(`decryption_type_select-${msg_id}-adv`);
		de_key_select = document.getElementById(`decryption_key_select-${msg_id}-adv`);
	   
		//var decrytion_type = decryption_type_select.value;
		decryption_type_select.addEventListener("change", function() {
			msg_id = options_for_decrypt_adv[i].id.split("-")[1];
			new_decryption_type_select =  document.getElementById(`decryption_type_select-${msg_id}-adv`);
			 de_default_key = document.getElementById(`default_key_select-${msg_id}-adv`);
			 de_key_select = document.getElementById(`decryption_key_select-${msg_id}-adv`);
			 all_options = de_key_select.querySelectorAll('option');
			 if (new_decryption_type_select.value === "symmetric") {
				 all_options.forEach((single_option) => {
					 single_option.disabled = true;
				 });
				 let shared = de_key_select.querySelectorAll('option[value^=Shared]');
				 shared.forEach((userItem) => {
					 userItem.disabled = false;
				 });
				 de_default_key.disabled = false
			 }
			 else if(new_decryption_type_select.value  === 'asymmetric' || new_decryption_type_select.value  === 'signed' ){
				 all_options.forEach((single_option) => {
					 single_option.disabled = false;
				 });
				 let shared = de_key_select.querySelectorAll('option[value^=Shared]');
				 shared.forEach((userItem) => {
					 userItem.disabled = true;
				 });
			 }
			 else{
				 all_options.forEach((single_option) => {
					 single_option.disabled = false;
				 });
			 }  
 
		 });
	 }
 
	</script>
<script>
	// Add an event listener to simulate a click on "User 2" tab when the page loads
	window.addEventListener('load', function () {
		var activeTab = sessionStorage.getItem('activeTab');
		console.log("Active Tab:", activeTab)
		// If there is an active tab, simulate a click on it
		if (activeTab) {
			var selector = '[name="' + activeTab + '"]';
			console.log(selector);
			document.querySelector(selector).click();
		} else {
			// Otherwise, click the first tab by default
			document.querySelector(".tablinks:first-child").click();
		}
	 });
 
	function openUser(evt, user) {
	   // Declare variables
	   var i, tabcontent, tablinks;
 
	   // Get all elements with class="tabcontent" and hide them
	   tabcontent = document.getElementsByClassName("tabcontent");
	   for (i = 0; i < tabcontent.length; i++) {
		  tabcontent[i].style.display = "none";
	   }
 
	   // Get all elements with class="tablinks" and remove the class "active"
	   tablinks = document.getElementsByClassName("tablinks");
	   for (i = 0; i < tablinks.length; i++) {
		  tablinks[i].className = tablinks[i].className.replace(" active", "");
	   }
 
	   // Show the current tab and add an "active" class to the button that opened the tab
	   document.getElementById(user).style.display = "block";
	   evt.currentTarget.className += " active";
	   sessionStorage.setItem('activeTab', user);
	}
 </script>	
 <script>
	// TODO: https://stackoverflow.com/questions/51135498/flask-update-the-page-content-without-redirection-in-ajax-jquery
	function decrypt(id_button){
		const msg_id = id_button.split("-")[1];
		console.log(msg_id);
		const decryption_type = document.getElementById(`decryption_type_select-${msg_id}-adv`).value;
		const decryption_key = document.getElementById(`decryption_key_select-${msg_id}-adv`).value;
		const current_user_username = id_button.split("-")[3];;
		var socket = io();
		socket.emit('decrypted', {message: msg_id,decryption_key:decryption_key,decryption_type:decryption_type,curname:current_user_username});
		socket.on('finish_decrypt_user',(arg1) => {
			if (arg1 !== "Good Job!"){
				alert(arg1); // 1
			}	
		});
		socket.on('redirect', function (data) {
			console.log(data.url)
			window.location.reload(true);
			window.location.href = data.url;
		});
	}
</script>
<script>

	// This script will limit the permission of certain key
	var options_for_decrypt = document.querySelectorAll('[data-group="decrypt_options"]');
	for (let i = 0; i < options_for_decrypt.length; i++) {
		msg_id = options_for_decrypt[i].id.split("-")[1];
		current_user_username = options_for_decrypt[i].id.split("-")[2].replace(',', '');
		decryption_type_select = document.getElementById(`decryption_type_select-${msg_id}`);
		de_key_select = document.getElementById(`decryption_key_select-${msg_id}`);
	   
		//var decrytion_type = decryption_type_select.value;
		decryption_type_select.addEventListener("change", function() {
			msg_id = options_for_decrypt[i].id.split("-")[1];
			new_decryption_type_select =  document.getElementById(`decryption_type_select-${msg_id}`);
			 de_default_key = document.getElementById(`default_key_select-${msg_id}`);
			 de_key_select = document.getElementById(`decryption_key_select-${msg_id}`);
			 all_options = de_key_select.querySelectorAll('option');
			 if (new_decryption_type_select.value === "symmetric") {
				 all_options.forEach((single_option) => {
					 single_option.disabled = true;
				 });
				 let shared = de_key_select.querySelectorAll('option[value^=Shared]');
				 shared.forEach((userItem) => {
					 userItem.disabled = false;
				 });
				 de_default_key.disabled = false
			 }
			 else if(new_decryption_type_select.value  === 'asymmetric' || new_decryption_type_select.value  === 'signed' ){
				 all_options.forEach((single_option) => {
					 single_option.disabled = false;
				 });
				 let shared = de_key_select.querySelectorAll('option[value^=Shared]');
				 shared.forEach((userItem) => {
					 userItem.disabled = true;
				 });
			 }
			 else{
				 all_options.forEach((single_option) => {
					 single_option.disabled = false;
				 });
			 }  
 
		 });
	 }
 
	</script>
<script>
	const encryptionTypeSelect = document.getElementById("encryption_sign_type_select_{{other_names[0]}}");
	const encryptionKeySelect = document.getElementById("key_select_{{other_names[0]}}");
	const defaultKeySelect = document.getElementById("default_key_select_{{other_names[0]}}");
 
	encryptionTypeSelect.addEventListener("change", () => {
	   if (encryptionTypeSelect.value === "-1") {
		  encryptionKeySelect.value = "-1";
	   }
	});
 
	var current_user_username = "{{ other_names[0] }}";
	var key_select = document.getElementById("key_select_{{other_names[0]}}");
	var encryption_type_select = document.getElementById("encryption_sign_type_select_{{other_names[0]}}");
	var default_key = document.getElementById("default_key_select_{{other_names[0]}}");
 
	encryption_type_select.addEventListener("change", function () {
	   let all_options = key_select.querySelectorAll('option');
	   var encryption_type = encryption_type_select.value;
 
	   if (encryption_type === 'symmetric') {
		  all_options.forEach((single_option) => {
			 single_option.disabled = true;
		  });
		  let shared = key_select.querySelectorAll('option[value^=Shared]');
		  shared.forEach((userItem) => {
			 userItem.disabled = false;
		  });
		  default_key.disabled = false;
	   } else if (encryption_type === 'asymmetric' || encryption_type === 'signed') {
		  all_options.forEach((single_option) => {
			 single_option.disabled = false;
		  });
		  let shared = key_select.querySelectorAll('option[value^=Shared]');
		  shared.forEach((userItem) => {
			 userItem.disabled = true;
		  });
	   } else {
		  all_options.forEach((single_option) => {
			 single_option.disabled = true;
		  });
	   }
	});
 
 </script>
 <script>
	const encryptionTypeSelect1 = document.getElementById("encryption_sign_type_select_{{other_names[1]}}");
	const encryptionKeySelect1 = document.getElementById("key_select_{{other_names[1]}}");
	const defaultKeySelect1 = document.getElementById("default_key_select_{{other_names[1]}}");
 
	encryptionTypeSelect1.addEventListener("change", () => {
	   if (encryptionTypeSelect1.value === "-1") {
		  encryptionKeySelect1.value = "-1";
	   }
	});
 
	var current_user_username1 = "{{ other_names[1] }}";
	var key_select1 = document.getElementById("key_select_{{other_names[1]}}");
	var encryption_type_select1 = document.getElementById("encryption_sign_type_select_{{other_names[1]}}");
	var default_key1 = document.getElementById("default_key_select_{{other_names[1]}}");
 
	encryption_type_select1.addEventListener("change", function () {
	   let all_options1 = key_select1.querySelectorAll('option');
	   var encryption_type1 = encryption_type_select1.value;
 
	   if (encryption_type1 === 'symmetric') {
		  all_options1.forEach((single_option1) => {
			 single_option1.disabled = true;
		  });
		  let shared1 = key_select1.querySelectorAll('option[value^=Shared]');
		  shared1.forEach((userItem1) => {
			 userItem1.disabled = false;
		  });
		  default_key1.disabled = false;
	   } else if (encryption_type1 === 'asymmetric' || encryption_type1 === 'signed') {
		  all_options1.forEach((single_option1) => {
			 single_option1.disabled = false;
		  });
		  let shared1 = key_select1.querySelectorAll('option[value^=Shared]');
		  shared1.forEach((userItem1) => {
			 userItem1.disabled = true;
		  });
	   } else {
		  all_options1.forEach((single_option1) => {
			 single_option1.disabled = true;
		  });
	   }
	});
 
 </script>
 <script>
	const encryptionTypeSelect2 = document.getElementById("encryption_sign_type_select2");
	const encryptionKeySelect2 = document.getElementById("key_select2");
	const defaultKeySelect2 = document.getElementById("default_key_select2");
 
	encryptionTypeSelect2.addEventListener("change", () => {
	   if (encryptionTypeSelect2.value === "-1") {
		  encryptionKeySelect2.value = "-1";
	   }
	});
 
	var key_select2 = document.getElementById("key_select2");
	var encryption_type_select2 = document.getElementById("encryption_sign_type_select2");
	var default_key2 = document.getElementById("default_key_select2");
 
	encryption_type_select2.addEventListener("change", function () {
	   let all_options2 = key_select2.querySelectorAll('option');
	   var encryption_type2 = encryption_type_select2.value;
 
	   if (encryption_type2 === 'symmetric') {
		  all_options2.forEach((single_option2) => {
			 single_option2.disabled = true;
		  });
		  let shared2 = key_select2.querySelectorAll('option[value^=Shared]');
		  shared2.forEach((userItem2) => {
			 userItem2.disabled = false;
		  });
		  default_key2.disabled = false;
	   } else if (encryption_type2 === 'asymmetric' || encryption_type2 === 'signed') {
		  all_options2.forEach((single_option2) => {
			 single_option2.disabled = false;
		  });
		  let shared2 = key_select2.querySelectorAll('option[value^=Shared]');
		  shared2.forEach((userItem2) => {
			 userItem2.disabled = true;
		  });
	   } else {
		  all_options2.forEach((single_option2) => {
			 single_option2.disabled = true;
		  });
	   }
	});
 
 </script>
{% endblock content %}
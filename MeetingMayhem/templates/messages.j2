{% macro print_msgs(msgs,usernames) -%}
{% for msg in msgs %}
{% if msg[0].is_edited %}
<!-- if the message has been edited, display the edited parts-->

<article class="media content-section">
    <div class="media-body">
        <div class="article-metadata">
            {% if msg[0].new_sender %}
            <a>Sender: {{ msg[0].new_sender }} | </a>
            {% else %}
            <a>Sender: {{ msg[0].sender }} | </a>
            {% endif %}
            {% if msg[0].new_recipient %}
            <a>Recipient: {{ msg[0].new_recipient }} </a>
            {% else %}
            <a>Recipient: {{ msg[0].recipient }} </a>
            {% endif %}
            <a> | Time Recieved: {{ msg[0].time_recieved }} </a>
        </div>
        {% if msg[0].edited_content %}
        <p class="article-content">{{ msg[0].edited_content }}</p>
        {% else %}
        <p class="article-content">{{ msg[0].content }}</p>
        {% endif %}
        {% if msg[0].is_encrypted %}
        <div class="m-1 row ">
            <div class="rounded-start d-inline col-md-auto bg-warning text-dark border border-3 border-warning">
                Encrypted For:</div>
            <div class="rounded-end d-inline col-md-auto border border-3 border-warning">{{ msg[0].encryption_details }}
            </div>
        </div>
        {% endif %}
        {% if msg[0].is_signed %}
        <div class="m-1 row">
            <div class="rounded-start d-inline col-md-auto bg-warning text-dark border border-3 border-warning">Signed
                by:</div>
            <div class="rounded-end d-inline col-md-auto border border-3 border-warning">{{ msg[0].signed_details }}
            </div>
        </div>
        {% endif %}
    </div>
</article>
{% else %}
{% set msg_id = msg[0].id %}
{% if msg[0].encryption_details == "invalid encrypted key" or msg[0].encryption_details == "invalid sign key" %}
<article class="media content-section">
    <div class="media-body">
        <div class="article-metadata">
            <a>Sender: {{ msg[0].sender }} | </a>
            <a>Recipient: {{ msg[0].recipient }}</a>
            <a> | Time Received: {{ msg[0].time_received }} </a>
        </div>
        <p class="article-content">{{ msg[0].content }}</p>
        {% if msg[0].is_encrypted %}
        <div class="m-1 row ">
            <div class="rounded-start d-inline col-md-auto bg-warning text-dark border border-3 border-warning">
                Encrypted For:</div>
            <div class="rounded-end d-inline col-md-auto border border-3 border-warning">{{ msg[0].encryption_details }}
            </div>
        </div>
        {% endif %}
        {% if msg[0].is_signed %}
        <div class="m-1 row">
            <div class="rounded-start d-inline col-md-auto bg-warning text-dark border border-3 border-warning">Signed
                by:</div>
            <div class="rounded-end d-inline col-md-auto border border-3 border-warning">{{ msg[0].signed_details }}
            </div>
        </div>
        {% endif %}
    </div>
</article>

{% else %}
<article class="media content-section">
    <div class="media-body">
        <div class="article-metadata">
            <a>Sender: {{ msg[0].sender }} | </a>
            <a>Recipient: {{ msg[0].recipient }}</a>
            <a> | Time Received: {{ msg[0].time_received }} </a>
        </div>


        <div class="row g-3 align-items-center">
           <div class="col-auto">
              <select id="encryption_type_select_new" class="form-select form-select-sm mb-3 gray-blue" aria-label=".form-select-lg example">
                 <option value= "-1" selected>No Encryption</option>
                 <option value="symmetric">Symmetric Encryption</option>
                 <option value="asymmetric">Asymmetric Encryption</option>
              </select>
           </div>
           <div class="col-auto">
              <select id="encryption_user_select_new" class="form-select form-select-sm mb-3 gray-blue" aria-label=".form-select-lg example">
                 <option value= "-1" selected>User</option>
                 {% for username in usernames %}
                 <option value="{{ username }}">{{ username }}</option>
                 {% endfor %}
              </select>
            </div>
           <div class="col-auto">
              <select id="encryption_key_select_new" class="form-select form-select-sm mb-3 gray-blue" aria-label=".form-select-lg example">
                 <option value= "-1" selected>Key Type</option>
                 <option value="public">Public</option>
                 <option value="private">Private</option>
              </select>
           </div>
        </div>

        <div class="row g-3 align-items-center">
           <div class="col-auto">
              <select id="signature_type_select_new" class="form-select form-select-sm mb-3 gray-blue" aria-label=".form-select-lg example">
                 <option value= "-1" selected>No Signature</option>
                 <option value="signed">Signed</option>
              </select>
           </div>
           <div class="col-auto">
              <select id="signature_user_select_new" class="form-select form-select-sm mb-3 gray-blue" aria-label=".form-select-lg example">
                 <option value= "-1" selected>User</option>
                 {% for username in usernames %}
                 <option value="{{ username }}">{{ username }}</option>
                 {% endfor %}
              </select>
           </div>
           <div class="col-auto">
              <select id="signature_key_select_new" class="form-select form-select-sm mb-3 gray-blue" aria-label=".form-select-lg example">
                 <option value= "-1" selected>Key Type</option>
                 <option value="public">Public</option>
                 <option value="private">Private</option>
              </select>
           </div>
        </div>
        <button id="decrypt-{{ msg_id }}" class="btn btn-secondary decrypt-button">Decrypt</button>
        <div id="content-{{ msg_id }}" class="content" style="display:none;">{{ msg[0].content }}</div>
    </div>
    {% if msg[0].is_encrypted %}
    <div class="m-1 row ">
        <div class="rounded-start d-inline col-md-auto bg-warning text-dark border border-3 border-warning">Encrypted
            For:</div>
        <div class="rounded-end d-inline col-md-auto border border-3 border-warning">{{ msg[0].encryption_details }}
        </div>
    </div>
    {% endif %}
    {% if msg[0].is_signed %}
    <div class="m-1 row">
        <div class="rounded-start d-inline col-md-auto bg-warning text-dark border border-3 border-warning">Signed by:
        </div>
        <div class="rounded-end d-inline col-md-auto border border-3 border-warning">{{ msg[0].signed_details }}</div>
    </div>
    {% endif %}
</article>
{% endif %}
{% endif%}

<script>
    var clicked = localStorage.getItem("clicked") || "";
    if (clicked.indexOf("{{ msg_id }}") !== -1) {
        document.getElementById("decrypt-{{ msg_id }}").style.display = "none";
        document.getElementById("content-{{ msg_id }}").style.display = "block";
    }
    document.getElementById("decrypt-{{ msg_id }}").addEventListener("click", function () {
        localStorage.setItem("clicked", clicked + "{{ msg_id }}");
        document.getElementById("decrypt-{{ msg_id }}").style.display = "none";
        document.getElementById("content-{{ msg_id }}").style.display = "block";
    });


</script>
{% endfor %}

{%- endmacro -%}
